// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Users {
  user_id           Int       @id @default(autoincrement())
  email             String    @unique
  password_hash     String
  full_name         String
  phone_number      String?
  avatar_url        String?
  date_of_birth     DateTime?
  gender            String?
  address           String?
  status            String    @default("active")
  email_verified    Boolean   @default(false)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  last_login        DateTime?

  admin    Admins?
  student  Students?
  teacher  Teachers?

  user_roles              User_Roles[]
  password_reset_tokens   Password_Reset_Tokens[]
  email_verifications     Email_Verifications[]
  user_otps               User_OTPs[]           // 🆕 Thêm bảng OTP
  trusted_devices         Trusted_Devices[]     // 🆕 Thêm bảng Trusted Devices
  notifications           Notifications[]       // 🆕 Thông báo nhận được
  notification_actors     Notifications[] @relation("NotificationActor") // 🆕 Thông báo tạo ra
  notification_settings   Notification_Settings? // 🆕 Cài đặt thông báo
}

model Admins {
  admin_id   Int      @id @default(autoincrement())
  user_id    Int      @unique
  manage_users         Boolean?
  manage_roles         Boolean?
  manage_system_settings Boolean?

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Students {
  student_id     Int      @id @default(autoincrement())
  user_id        Int      @unique
  school         String?
  major          String?
  specialization String?

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Teachers {
  teacher_id Int @id @default(autoincrement())
  user_id    Int @unique

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  teaching_experiences Teaching_Experiences[]
}

model Teaching_Experiences {
  experience_id Int @id @default(autoincrement())
  teacher_id    Int
  school_name   String
  subject       String
  start_date    DateTime
  end_date      DateTime?

  teacher Teachers @relation(fields: [teacher_id], references: [teacher_id], onDelete: Cascade)
}

model Roles {
  role_id     Int       @id @default(autoincrement())
  role_name   String    @unique
  description String?
  created_at  DateTime  @default(now())

  user_roles  User_Roles[]
}

model User_Roles {
  user_role_id Int      @id @default(autoincrement())
  user_id      Int
  role_id      Int
  assigned_at  DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role Roles @relation(fields: [role_id], references: [role_id], onDelete: Cascade)

  @@unique([user_id, role_id])
}

model Password_Reset_Tokens {
  token_id   Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Email_Verifications {
  verification_id Int      @id @default(autoincrement())
  user_id         Int
  token           String   @unique
  expires_at      DateTime
  verified        Boolean  @default(false)
  created_at      DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

// 🆕 Bảng cho OTP
model User_OTPs {
  otp_id     Int      @id @default(autoincrement())
  user_id    Int
  code       String   // mã OTP (ví dụ: "123456")
  purpose    String   // 'login', 'verify_email', 'reset_password', ...
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id, purpose])
}

// 🆕 Bảng cho Trusted Devices - Ghi nhớ thiết bị
model Trusted_Devices {
  device_id       Int      @id @default(autoincrement())
  user_id         Int
  device_token    String   @unique  // Token định danh thiết bị (fingerprint)
  device_name     String?  // Tên thiết bị (vd: "Chrome on Windows")
  device_type     String?  // Loại thiết bị: "desktop", "mobile", "tablet"
  user_agent      String?  // User agent string
  ip_address      String?  // IP address
  last_used       DateTime @default(now())
  expires_at      DateTime // Hết hạn sau 30 ngày
  created_at      DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id, device_token])
  @@index([expires_at])
}

// 🆕 Bảng Thông báo
model Notifications {
  notification_id   Int      @id @default(autoincrement())
  user_id          Int      // Người nhận thông báo
  actor_id         Int?     // Người gây ra hành động (có thể null cho system notifications)
  type             String   // 'forum_reply', 'assignment_graded', 'mention', 'system', etc.
  title            String   // Tiêu đề ngắn gọn
  content          String   // Nội dung chi tiết
  data             Json?    // Dữ liệu bổ sung (post_id, assignment_id, etc.)
  is_read          Boolean  @default(false)
  created_at       DateTime @default(now())
  read_at          DateTime?

  user  Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  actor Users? @relation("NotificationActor", fields: [actor_id], references: [user_id], onDelete: SetNull)

  @@index([user_id, is_read])
  @@index([user_id, created_at])
  @@index([type])
}

// 🆕 Cài đặt thông báo của người dùng
model Notification_Settings {
  settings_id           Int     @id @default(autoincrement())
  user_id              Int     @unique
  
  // Thông báo trên web
  web_forum_reply      Boolean @default(true)   // Khi ai đó trả lời bài viết
  web_mention          Boolean @default(true)   // Khi được mention
  web_assignment_grade Boolean @default(true)   // Khi bài tập được chấm điểm
  web_system           Boolean @default(true)   // Thông báo hệ thống
  
  // Thông báo email
  email_important      Boolean @default(true)   // Email cho hoạt động quan trọng
  email_weekly_summary Boolean @default(false)  // Email tổng hợp hàng tuần
  
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}
