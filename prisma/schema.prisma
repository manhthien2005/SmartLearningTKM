// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Users {
  user_id           Int       @id @default(autoincrement())
  email             String    @unique
  password_hash     String
  full_name         String
  phone_number      String?
  avatar_url        String?
  date_of_birth     DateTime?
  gender            String?
  address           String?
  status            String    @default("active")
  email_verified    Boolean   @default(false)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  last_login        DateTime?

  admin    Admins?
  student  Students?
  teacher  Teachers?

  user_roles              User_Roles[]
  password_reset_tokens   Password_Reset_Tokens[]
  email_verifications     Email_Verifications[]
  user_otps               User_OTPs[]           // ğŸ†• ThÃªm báº£ng OTP
  trusted_devices         Trusted_Devices[]     // ğŸ†• ThÃªm báº£ng Trusted Devices
  notifications           Notifications[]       // ğŸ†• ThÃ´ng bÃ¡o nháº­n Ä‘Æ°á»£c
  notification_actors     Notifications[] @relation("NotificationActor") // ğŸ†• ThÃ´ng bÃ¡o táº¡o ra
  notification_settings   Notification_Settings? // ğŸ†• CÃ i Ä‘áº·t thÃ´ng bÃ¡o
}

model Admins {
  admin_id   Int      @id @default(autoincrement())
  user_id    Int      @unique
  manage_users         Boolean?
  manage_roles         Boolean?
  manage_system_settings Boolean?

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Students {
  student_id     Int      @id @default(autoincrement())
  user_id        Int      @unique
  school         String?
  major          String?
  specialization String?

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Teachers {
  teacher_id Int @id @default(autoincrement())
  user_id    Int @unique

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  teaching_experiences Teaching_Experiences[]
}

model Teaching_Experiences {
  experience_id Int @id @default(autoincrement())
  teacher_id    Int
  school_name   String
  subject       String
  start_date    DateTime
  end_date      DateTime?

  teacher Teachers @relation(fields: [teacher_id], references: [teacher_id], onDelete: Cascade)
}

model Roles {
  role_id     Int       @id @default(autoincrement())
  role_name   String    @unique
  description String?
  created_at  DateTime  @default(now())

  user_roles  User_Roles[]
}

model User_Roles {
  user_role_id Int      @id @default(autoincrement())
  user_id      Int
  role_id      Int
  assigned_at  DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role Roles @relation(fields: [role_id], references: [role_id], onDelete: Cascade)

  @@unique([user_id, role_id])
}

model Password_Reset_Tokens {
  token_id   Int      @id @default(autoincrement())
  user_id    Int
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Email_Verifications {
  verification_id Int      @id @default(autoincrement())
  user_id         Int
  token           String   @unique
  expires_at      DateTime
  verified        Boolean  @default(false)
  created_at      DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

// ğŸ†• Báº£ng cho OTP
model User_OTPs {
  otp_id     Int      @id @default(autoincrement())
  user_id    Int
  code       String   // mÃ£ OTP (vÃ­ dá»¥: "123456")
  purpose    String   // 'login', 'verify_email', 'reset_password', ...
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id, purpose])
}

// ğŸ†• Báº£ng cho Trusted Devices - Ghi nhá»› thiáº¿t bá»‹
model Trusted_Devices {
  device_id       Int      @id @default(autoincrement())
  user_id         Int
  device_token    String   @unique  // Token Ä‘á»‹nh danh thiáº¿t bá»‹ (fingerprint)
  device_name     String?  // TÃªn thiáº¿t bá»‹ (vd: "Chrome on Windows")
  device_type     String?  // Loáº¡i thiáº¿t bá»‹: "desktop", "mobile", "tablet"
  user_agent      String?  // User agent string
  ip_address      String?  // IP address
  last_used       DateTime @default(now())
  expires_at      DateTime // Háº¿t háº¡n sau 30 ngÃ y
  created_at      DateTime @default(now())

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id, device_token])
  @@index([expires_at])
}

// ğŸ†• Báº£ng ThÃ´ng bÃ¡o
model Notifications {
  notification_id   Int      @id @default(autoincrement())
  user_id          Int      // NgÆ°á»i nháº­n thÃ´ng bÃ¡o
  actor_id         Int?     // NgÆ°á»i gÃ¢y ra hÃ nh Ä‘á»™ng (cÃ³ thá»ƒ null cho system notifications)
  type             String   // 'forum_reply', 'assignment_graded', 'mention', 'system', etc.
  title            String   // TiÃªu Ä‘á» ngáº¯n gá»n
  content          String   // Ná»™i dung chi tiáº¿t
  data             Json?    // Dá»¯ liá»‡u bá»• sung (post_id, assignment_id, etc.)
  is_read          Boolean  @default(false)
  created_at       DateTime @default(now())
  read_at          DateTime?

  user  Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  actor Users? @relation("NotificationActor", fields: [actor_id], references: [user_id], onDelete: SetNull)

  @@index([user_id, is_read])
  @@index([user_id, created_at])
  @@index([type])
}

// ğŸ†• CÃ i Ä‘áº·t thÃ´ng bÃ¡o cá»§a ngÆ°á»i dÃ¹ng
model Notification_Settings {
  settings_id           Int     @id @default(autoincrement())
  user_id              Int     @unique
  
  // ThÃ´ng bÃ¡o trÃªn web
  web_forum_reply      Boolean @default(true)   // Khi ai Ä‘Ã³ tráº£ lá»i bÃ i viáº¿t
  web_mention          Boolean @default(true)   // Khi Ä‘Æ°á»£c mention
  web_assignment_grade Boolean @default(true)   // Khi bÃ i táº­p Ä‘Æ°á»£c cháº¥m Ä‘iá»ƒm
  web_system           Boolean @default(true)   // ThÃ´ng bÃ¡o há»‡ thá»‘ng
  
  // ThÃ´ng bÃ¡o email
  email_important      Boolean @default(true)   // Email cho hoáº¡t Ä‘á»™ng quan trá»ng
  email_weekly_summary Boolean @default(false)  // Email tá»•ng há»£p hÃ ng tuáº§n
  
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  user Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}
